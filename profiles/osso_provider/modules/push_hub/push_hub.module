<?php

/**
 * @file
 *
 * @todo Support notifications from publishers over HTTP.
 */

include_once('PuSHHub.inc');

/**
 * Implementation of hook_menu().
 */
function push_hub_menu() {
  $items = array();
  $items['pubsubhubbub/endpoint'] = array(
   'page callback' => 'push_hub_endpoint',
   'page arguments' => array(3, 4),
   'access callback' => 'user_access',
   'access arguments' => array('access content'), // @todo Specific permission
   'file' => 'push_hub.pages.inc',
   'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Instantiates a PuSH Hub object.
 */
function push_hub() {
  return PuSHHub::instance(PuSHHubSubscriptions::instance());
}

/**
 * A PuSHHub Subscriptions.
 */
class PuSHHubSubscriptions implements PuSHHubSubscriptionsInterface {
  /**
   * Singleton.
   */
  public function instance() {
    static $subscriptions;
    if (empty($subscriptions)) {
      $subscriptions = new PuSHHubSubscriptions();
    }
    return $subscriptions;
  }

  /**
   * Protect constructor.
   */
  protected function __construct() {
  }

  /**
   * Save a subscription.
   */
  public function save($topic, $subscriber) {
    $this->delete($topic, $subscriber);
    $subscription = array(
      'topic' => $topic,
      'subscriber' => $subscriber,
      'timestamp' => time(),
    );
    drupal_write_record('push_hub_subscriptions', $subscription);
  }

  /**
   * Delete a subscription.
   */
  public function delete($topic, $subscriber) {
    db_query("DELETE FROM {push_hub_subscriptions} WHERE topic = '%s' AND subscriber = '%s'", $topic, $subscriber);
  }

  /**
   * Find all subscriber URLs for a given topic URL.
   *
   * @return
   *   An array of subscriber URLs.
   */
  public function all($topic) {
    $subscribers = array();
    $result = db_query("SELECT subscriber FROM {push_hub_subscriptions} WHERE topic = '%s'", $topic);
    while ($row = db_fetch_object($result)) {
      $subscribers[] = $row->subscriber;
    }
    return $subscribers;
  }
}
