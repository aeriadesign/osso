<?php

/**
 * @file
 *
 * @todo Support notifications from publishers over HTTP.
 */

/**
 * Implementation of hook_menu().
 */
function push_hub_menu() {
  $items = array();
  $items['pubsubhubbub/endpoint'] = array(
   'page callback' => 'push_hub_endpoint',
   'page arguments' => array(3, 4),
   'access callback' => 'user_access',
   'access arguments' => array('access content'), // @todo Specific permission
   'file' => 'push_hub.pages.inc',
   'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Instantiates a PuSH Hub object.
 */
function push_hub() {
  module_load_include('inc', 'push_hub', 'PuSHHub');
  return PuSHHub::instance();
}

/**
 * A PuSHHub Subscription.
 */
class PuSHHubSubscription implements PuSHHubSubscriptionInterface {
  protected $topic;
  protected $subscriber;

  /**
   * Constructor.
   */
  public function __construct($topic, $subscriber) {
    $this->topic = $topic;
    $this->subscriber = $subscriber;
  }

  /**
   * Save a subscription.
   */
  public function save() {
    $this->delete();
    $subscription = array(
      'topic' => $this->topic,
      'subscriber' => $this->subscriber,
      'timestamp' => time(),
    );
    drupal_write_record('push_hub_subscriptions', $subscription);
  }

  /**
   * Delete a subscription.
   */
  public function delete() {
    db_query("DELETE FROM {push_hub_subscriptions} WHERE topic = '%s' AND subscriber = '%s'", $this->topic, $this->subscriber);
  }

  /**
   * Find all subscriber URLs for a given topic URL.
   *
   * @return
   *   An array of subscriber URLs.
   */
  public static function all($topic) {
    $subscribers = array();
    $result = db_query("SELECT subscriber FROM {push_hub_subscriptions} WHERE topic = '%s'", $topic);
    while ($row = db_fetch_object($result)) {
      $subscribers[] = $row->subscriber;
    }
    return $subscribers;
  }
}
